# Docker Compose configuration for AEFL federated learning clients.
#
# This file launches five logical IoT roles as separate containers:
#   - roadside
#   - vehicle
#   - sensor
#   - camera
#   - bus
#
# The DATASET and FL_MODE variables are provided at runtime, e.g.:
#   export DATASET=sz
#   export FL_MODE=AEFL
#   docker compose up -d

x-common: &common
  build:
    context: .
    dockerfile: Dockerfile

  working_dir: /app
  network_mode: host
  restart: "no"

  volumes:
    - .:/app
    - ./run_logs:/app/run_logs
    - ~/.aws:/home/aefluser/.aws:ro

  environment: &common-env
    AWS_REGION: "us-east-1"
    S3_BUCKET: "aefl"

    # Experiment configuration (must be exported by the caller)
    DATASET: "${DATASET}"
    FL_MODE: "${FL_MODE}"
    VARIANT_ID: "${VARIANT_ID}"

    # Federated learning hyperparameters
    FL_ROUNDS: 20
    BATCH_SIZE: 64
    LOCAL_EPOCHS: 1
    LR: 0.001
    HIDDEN_SIZE: 64

    # Device + network energy model (overridable)
    DEVICE_POWER_WATTS: 3.5
    NET_J_PER_MB: 0.6

    # Differential privacy settings (overridable)
    DP_ENABLED: "false"
    DP_SIGMA: 0.01

    # Compression settings (overridable)
    COMPRESSION_ENABLED: "false"
    COMPRESSION_MODE: "sparsify"
    COMPRESSION_SPARSITY: 0.5
    COMPRESSION_K_FRAC: 0.1

services:

  client_roadside:
    <<: *common
    container_name: client_roadside
    environment:
      <<: *common-env
      CLIENT_ROLE: "roadside"
      DEVICE_POWER_WATTS: 2.0 # low-power roadside sensor
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_vehicle:
    <<: *common
    container_name: client_vehicle
    environment:
      <<: *common-env
      CLIENT_ROLE: "vehicle"
      DEVICE_POWER_WATTS: 4.0 # medium/high vehicular unit
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_sensor:
    <<: *common
    container_name: client_sensor
    environment:
      <<: *common-env
      CLIENT_ROLE: "sensor"
      DEVICE_POWER_WATTS: 2.5 # embedded IoT sensor
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_camera:
    <<: *common
    container_name: client_camera
    environment:
      <<: *common-env
      CLIENT_ROLE: "camera"
      DEVICE_POWER_WATTS: 5.0 # high-power camera node
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_bus:
    <<: *common
    container_name: client_bus
    environment:
      <<: *common-env
      CLIENT_ROLE: "bus"
      DEVICE_POWER_WATTS: 4.0 # medium/high-powered vehicle system
    command: [ "python", "-u", "-m", "src.fl.client" ]
